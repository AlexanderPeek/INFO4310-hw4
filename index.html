<html>
  <head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        background-color: #393939;
        color: white; /* Set text color to white for better visibility */
      }
      .display-none {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <img src="images/header.png" alt="Header" id="headerImg" />
    <div style="display: flex; flex-direction: row;">
      <svg id="filters" height="600" width="300" style="margin-left: 121px"></svg>
      <svg
        id="bubbleGraph"
        height="660"
        width="870"
      ></svg> 
  </div>
  </body>
  <script>
    const filterSvg = d3.select("#filters");
    const filterWidth = filterSvg.attr("width");
    const filterHeight = filterSvg.attr("height");

    const appliedFilters = [];

    const bubbleSvg = d3.select("#bubbleGraph");
    const bubbleWidth = bubbleSvg.attr("width");
    const bubbleHeight = bubbleSvg.attr("height");

    const placementHelper = (height, width, i) => {
      if (i < 3) {
        return `translate(${(filterWidth / 4) * (i + 1) - 15 / 2}, ${
          filterHeight / 5
        })`;
      } else if (i < 6) {
        i = i - 3;
        return `translate(${(filterWidth / 4) * (i + 1) - 15 / 2}, ${
          (filterHeight / 5) * 2
        })`;
      } else if (i < 9) {
        i = i - 5;
        return `translate(${(filterWidth / 4) * (i + 1) - 15 / 2}, ${
          (filterHeight / 5) * 3
        })`;
      }
    };

    const addFilterButtons = (labels, svg) => {
      labels.forEach((label, i) => {
        if(label === "Deselect All"){
          const button = svg
          .data([label])
          .append("g")
          .attr("transform", `translate(0, ${i * 55 + 50})`)
          .attr("class", "g-color")
          .on("click", () => handleFilterClick(label, svg));
          button
          .append("text")
          .attr(
            "class",
            `rect-${
              label == "Peanuty Almondy"
                ? "peanutyalmondy"
                : label == "Crisped Rice Wafer"
                ? "crispedricewafer"
                : label
            } color-text`
          )
          .text(label)
          .attr("x", 10)
          .attr("y", i + 14)
          .style("font-size", "20px")
          .style("fill", "white");
        } else {
          const button = svg
          .data([label])
          .append("g")
          .attr("transform", `translate(10, ${i * 55 + 50})`)
          .attr("class", "g-color")
          .on("click", () => handleFilterClick(label, svg));

        button
          .append("rect")
          .attr(
            "class",
            `rect-${
              label == "Peanuty Almondy"
                ? "peanutyalmondy"
                : label == "Crisped Rice Wafer"
                ? "crispedricewafer"
                : label
            } color-rect`
          )
          .attr("width", 17)
          .attr("height", 17)
          .attr("y", i)
          .style("border-radius", "20px")
          .attr("fill", "none")
          .attr("stroke", "white");

        button
          .append("text")
          .attr(
            "class",
            `rect-${
              label == "Peanuty Almondy"
                ? "peanutyalmondy"
                : label == "Crisped Rice Wafer"
                ? "crispedricewafer"
                : label
            } color-text`
          )
          .text(label)
          .attr("x", 25)
          .attr("y", i + 14)
          .style("font-size", "20px")
          .style("fill", "white");

        }
        
      });
    };

    let boxStates = {};

    const handleFilterClick = (label, svg) => {
      let modifiedLabel = label == "Peanuty Almondy"
            ? "peanutyalmondy"
            : label == "Crisped Rice Wafer"
            ? "crispedricewafer"
            : label;
      if(modifiedLabel === "Deselect All"){
        svg.selectAll(".color-rect").attr("fill", "none").attr("stroke", "white");
        appliedFilters.length = 0;
      } else {
        const box = svg.select(
          `.rect-${modifiedLabel
          }`
        );
        if (boxStates[modifiedLabel] === undefined || !boxStates[modifiedLabel]) {
          box.attr("fill", "#FF932C").attr("stroke", "#FF932C");
          boxStates[modifiedLabel] = true;
          appliedFilters.push(modifiedLabel);
        } else {
          box.attr("fill", "none").attr("stroke", "white");
          boxStates[modifiedLabel] = false;
          appliedFilters.splice(appliedFilters.indexOf(modifiedLabel), 1);
        }

      }
      const c = appliedFilters.join(' '); // Join filters with spaces

      if(!c){
        bubbleSvg.selectAll(".candy").classed("display-none", false);
      } else{
        bubbleSvg.selectAll(".candy").classed("display-none", d => !c || !c.split(' ').some(f => classString[d.data.competitorname].includes(f)));
      }
            
      
    };

    const classString = {};

    const getData = async () => {
      const allData = await d3.csv("candy-data.csv");
      const data = allData.filter(item => item.competitorname !== "One dime" && item.competitorname !== "One quarter");
      console.log(data);
      const filters = [
        "Chocolate",
        "Fruity",
        "Caramel",
        "Peanuty Almondy",
        "Nougat",
        "Crisped Rice Wafer",
        "Hard",
        "Bar",
        "Pluribus",
        "Deselect All"
      ];
      addFilterButtons(filters, filterSvg);

      data.forEach((d) => {
        classString[d["competitorname"]] = `candy ${d["competitorname"]} ${d["chocolate"] === "1" ? "Chocolate" : ""} ${d["fruity"] === "1" ? "Fruity" : ""} ${d["caramel"] === "1" ? "Caramel" : ""} ${d["peanutyalmondy"] === "1" ? "peanutyalmondy" : ""} ${d["nougat"] === "1" ? "Nougat" : ""} ${d["crispedricewafer"] === "1" ? "crispedricewafer" : ""} ${d["hard"] === "1" ? "Hard" : ""} ${d["bar"] === "1" ? "Bar" : ""} ${d["pluribus"] === "1" ? "Pluribus" : ""}`
      })

      console.log("class", classString);

      const radiusScale = d3
        .scaleLinear()
        .domain(d3.extent(data, (d) => parseFloat(d["winpercent"])))
        .range([15, 50]);

      const pack = d3
        .pack()
        .size([bubbleWidth, bubbleHeight])
        .padding(2);

      const root = d3.hierarchy({ children: data }).sum((d) => d["winpercent"]);

      pack(root);

      const simulation = d3.forceSimulation(root.leaves())
                          .force("charge", d3.forceManyBody().strength(10))
                          .force("collide", d3.forceCollide().radius(d => radiusScale(parseFloat(d.data.winpercent))))
                          .on("tick", () => {
                            bubbles.attr("x", (d) => d.x - radiusScale(parseFloat(d.data.winpercent)))
                                    .attr("y", (d) => d.y - radiusScale(parseFloat(d.data.winpercent)));
                          });

      // const bubbles = bubbleSvg
      //   .selectAll(".candy")
      //   .data(root.leaves())
      //   .enter()
      //   .append("circle")
      //   .attr("class", (d) => classString[d.data.competitorname])
      //   .attr("cx", (d) => d.x).attr("cy", (d) => d.y)
      //   .attr("r", (d) => radiusScale(parseFloat(d.data.winpercent)))
      //   .attr("fill", "blue")
      //   .attr("opacity", 0.7)
      //   .on("mouseover", (event, d) => {
      //     console.log(d.data);
      //   });

      const bubbles = bubbleSvg
        .selectAll(".candy")
        .data(root.leaves())
        .enter()
        .append("image")
        .attr("class", (d) => classString[d.data.competitorname])
        .attr("xlink:href", "images/candyIcon.svg")
        .attr("x", (d) => d.x - radiusScale(parseFloat(d.data.winpercent)))
        .attr("y", (d) => d.y - radiusScale(parseFloat(d.data.winpercent)))
        .attr("width", (d) => 2 * radiusScale(parseFloat(d.data.winpercent)))
        .attr("height", (d) => 2 * radiusScale(parseFloat(d.data.winpercent)))
        .style("fill", "blue")
        .attr("opacity", 0.7)
        .on("mouseover", (event, d) => {
          console.log(d.data);
        });
    };

    getData();
  </script>
</html>
